version: "3.9"

# ============================================================
#  NEXUS — Development Override
#  Użycie: make dev
#  Lub: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
#
#  Zmiany vs. produkcja:
#  - Hot reload dla backendu i frontendu
#  - Montowanie kodu źródłowego
#  - Logi bardziej szczegółowe
#  - Flower bez autoryzacji
# ============================================================

services:
  backend:
    command: >
      uvicorn api.main:app
      --host 0.0.0.0
      --port 8000
      --reload
      --reload-dir /app
      --log-level debug
    volumes:
      - ./backend:/app:cached
      - nexus-dane:/app/dane
      - nexus-temp:/tmp/nexus
    environment:
      DEBUG: "true"
      SRODOWISKO: development

  celery-worker:
    command: >
      celery -A celery_app worker
      --loglevel=debug
      --concurrency=1
      --queues=wideo,analityka
      --hostname=worker-dev@%%h
    volumes:
      - ./backend:/app:cached
      - nexus-dane:/app/dane
      - nexus-temp:/tmp/nexus
    environment:
      DEBUG: "true"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ./frontend:/app:cached
      - /app/node_modules
      - /app/.next
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost/api
    command: npm run dev

  # W trybie dev Flower bez autoryzacji
  flower:
    environment:
      FLOWER_BASIC_AUTH: ""

  # PgAdmin dla wygodnego zarządzania bazą (tylko dev)
  pgadmin:
    image: dpage/pgadmin4:8.13
    container_name: nexus-pgadmin
    restart: unless-stopped
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@nexus.local
      PGADMIN_DEFAULT_PASSWORD: nexus
      PGADMIN_CONFIG_SERVER_MODE: "False"
    volumes:
      - pgadmin-dane:/var/lib/pgadmin
    networks:
      - nexus-public
      - nexus-internal

  # Redis Commander (UI dla Redis)
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: nexus-redis-commander
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      REDIS_HOSTS: local:redis:6379:0:${REDIS_PASSWORD:-nexus2026}
    networks:
      - nexus-public
      - nexus-internal

volumes:
  pgadmin-dane:
    driver: local

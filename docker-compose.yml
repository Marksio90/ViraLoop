# ViraLoop – Docker Compose dla środowiska deweloperskiego
# Uruchom: docker compose up -d
# Zatrzymaj: docker compose down

version: "3.9"

networks:
  viraloop-siec:
    driver: bridge

volumes:
  clickhouse-dane:
  qdrant-dane:
  redis-dane:
  postgres-dane:
  minio-dane:

services:

  # ── Frontend Next.js 16 ─────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: ../infrastructure/docker/Dockerfile.frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://backend:8000
      - NEXT_PUBLIC_WS_URL=ws://backend:8000
    depends_on:
      - backend
    networks:
      - viraloop-siec
    restart: unless-stopped

  # ── Backend FastAPI ─────────────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: ../infrastructure/docker/Dockerfile.backend
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - CLICKHOUSE_HOST=clickhouse
      - QDRANT_URL=http://qdrant:6333
      - REDIS_URL=redis://redis:6379/0
      - POSTGRES_URL=postgresql+asyncpg://viraloop:tajne_haslo@postgres:5432/viraloop
    depends_on:
      clickhouse:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - viraloop-siec
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: "8G"

  # ── Kolejka zadań Celery ─────────────────────────────────────────────────
  worker-celery:
    build:
      context: ./backend
      dockerfile: ../infrastructure/docker/Dockerfile.backend
    command: celery -A backend.utils.celery_app worker --loglevel=info --concurrency=4
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CLICKHOUSE_HOST=clickhouse
      - QDRANT_URL=http://qdrant:6333
    depends_on:
      - redis
      - backend
    networks:
      - viraloop-siec
    restart: unless-stopped

  # ── ClickHouse v26.1 ──────────────────────────────────────────────────
  clickhouse:
    image: clickhouse/clickhouse-server:26.1
    ports:
      - "8123:8123"   # HTTP API
      - "9000:9000"   # Native protocol
    volumes:
      - clickhouse-dane:/var/lib/clickhouse
      - ./infrastructure/docker/clickhouse-config.xml:/etc/clickhouse-server/config.d/custom.xml:ro
    environment:
      - CLICKHOUSE_DB=viraloop
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - viraloop-siec
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Qdrant (baza wektorowa "DNA wideo") ────────────────────────────────
  qdrant:
    image: qdrant/qdrant:v1.12.1
    ports:
      - "6333:6333"   # HTTP API
      - "6334:6334"   # gRPC
    volumes:
      - qdrant-dane:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
    networks:
      - viraloop-siec
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Redis (cache, kolejka zadań) ────────────────────────────────────────
  redis:
    image: redis:7.4-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-dane:/data
    command: redis-server --save 60 1 --loglevel warning --maxmemory 2gb --maxmemory-policy allkeys-lru
    networks:
      - viraloop-siec
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── PostgreSQL (dane użytkowników, projekty, metadane) ─────────────────
  postgres:
    image: postgres:17-alpine
    ports:
      - "5432:5432"
    volumes:
      - postgres-dane:/var/lib/postgresql/data
      - ./infrastructure/docker/init-postgres.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      - POSTGRES_DB=viraloop
      - POSTGRES_USER=viraloop
      - POSTGRES_PASSWORD=tajne_haslo
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8
    networks:
      - viraloop-siec
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U viraloop -d viraloop"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── MinIO (obiektowe storage wideo i audio) ─────────────────────────────
  minio:
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    ports:
      - "9001:9001"   # API
      - "9002:9002"   # Konsola webowa
    volumes:
      - minio-dane:/data
    environment:
      - MINIO_ROOT_USER=viraloop_admin
      - MINIO_ROOT_PASSWORD=tajne_haslo_minio_min32znaki
    command: server /data --console-address ":9002"
    networks:
      - viraloop-siec
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9001/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ── Prometheus (metryki systemu) ────────────────────────────────────────
  prometheus:
    image: prom/prometheus:v3.1.0
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - viraloop-siec
    restart: unless-stopped

  # ── Grafana (wizualizacja metryk) ───────────────────────────────────────
  grafana:
    image: grafana/grafana:11.4.0
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_FEATURE_TOGGLES_ENABLE=publicDashboards
    volumes:
      - ./infrastructure/docker/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
    depends_on:
      - prometheus
    networks:
      - viraloop-siec
    restart: unless-stopped
